suite: base cronjob test
templates:
  - templates/cronjob.yaml
release:
  name: my-cronjob
  namespace: my-namespace
  revision: 1
  upgrade: true
capabilities:
  majorVersion: 1
  minorVersion: 10
  apiVersions:
    - br.dev.local/v2
chart:
  version: 1.0.0
  appVersion: 1.0.0
tests:
  - it: cron config
    set:
      cron.schedule: "* * * * *"
      cron.failedJobsHistoryLimit: 30
      cron.successfulJobsHistoryLimit: 40
      cron.concurrencyPolicy: "Replace"
      cron.startingDeadlineSeconds: 50
    asserts:
      - isKind:
          of: CronJob
      - matchRegex:
          path: metadata.name
          pattern: my-cronjob
      - equal:
          path: spec.schedule
          value: "* * * * *"
      - equal:
          path: spec.failedJobsHistoryLimit
          value: 30
      - equal:
          path: spec.successfulJobsHistoryLimit
          value: 40
      - equal:
          path: spec.concurrencyPolicy
          value: "Replace"
      - equal:
          path: spec.startingDeadlineSeconds
          value: 50

  - it: job config
    set:
      job.id: some-id
      job.name: some-name
      job.command: ls
      job.arguments: '-lah foo bar'
      job.backoffLimit: 300
      job.parallelism: 20
      job.ttlSecondsAfterFinished: 100
      job.activeDeadlineSeconds: 850
      job.completions: 3
      job.suspend: true
    asserts:
      - isSubset:
          path: spec.jobTemplate.spec
          count: 1
          any: true
          content:
            backoffLimit: 300
            parallelism: 20
            ttlSecondsAfterFinished: 100
            activeDeadlineSeconds: 850
            completions: 3
            suspend: true
      - isSubset:
          path: spec.jobTemplate.spec.template.spec.containers[0]
          content:
            name: "some-name"
            args:
              - -lah
              - foo
              - bar
            command:
              - ls